app.directive("lazy",["$window",function(e,n){function t(e){return e.__uid||(e.__uid=""+ ++d)}function r(e,n){var t=e.getBoundingClientRect();return t.top-document.documentElement.scrollTop-("undefined"==typeof n?600:n)<=document.documentElement.clientHeight?!0:!1}function c(){Object.keys(l).forEach(function(e){var n=l[e],t=n.$scope.preload,c=n.$scope;iElement=n.iElement,r(iElement,t)&&o(iElement,c,n)})}function o(e,n,r){if(r&&!r.isLoading||!r){var c=document.createElement("img"),o=t(e);e=angular.element(e),c.src=e.attr("scsrc"),r&&(r.isLoading=!0),c.onload=function(){r&&(r.isLoading=!1),a(n,"sc"),e.attr("src",c.src),l.hasOwnProperty(o)&&delete l[o]},c.onerror=function(){r&&(r.isLoading=!1),e.attr("src",e.attr("ersrc")),a(n,"er")}}}function a(e,n){if(-1==["sc","df","er"].indexOf(n))return void console.log("state赋值错误");e.state=n,e["on"+n]&&e["on"+n]();try{e.$parent.$digest()}catch(t){}}var s=e,i=angular.element(s),d=0,l={};return i.bind("touchmove",c),i.bind("scroll",c),{restrict:"A",scope:{lazy:"@",preload:"@",ersrc:"@",dfsrc:"@",scsrc:"@",onsc:"&",oner:"&",ondf:"&",hasAnimate:"@"},link:function(e,n){e.lazy="false"==e.lazy||0==e.lazy?!1:!0,e.hasAnimate="false"==e.hasAnimate||0==e.hasAnimate?!1:!0,n=n[0];var c=t(n);n.src=e.dfsrc,a(e,"df"),e.preload=e.preload?Number(e.preload):600;var s=[];s[0]=e.$watch("dfsrc",function(){"df"==e.state&&(n.src=e.dfsrc)}),s[1]=e.$watch("ersrc",function(){"er"==e.state&&(n.src=e.ersrc)}),s[2]=e.$watch("scsrc",function(){n.src=e.dfsrc,a(e,"df"),e.lazy&&!r(n,e.preload)?l[c]={iElement:n,$scope:e}:o(n,e)}),e.$on("$destroy",function(){l.hasOwnProperty(c)&&delete l[c],s.forEach(function(e){e()})})}}}]);